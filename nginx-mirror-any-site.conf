server {
    listen 80;
    server_name test.top;

    return 301 https://\$host\$request_uri;
}

server {
    listen 443 ssl;
    server_name test.top;
    
    # SSL证书配置
    ssl_certificate /etc/letsencrypt/live/test.top/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/test.top/privkey.pem;
    
    # Authelia集成
    include /etc/nginx/snippets/authelia.conf;

    location = / {
    
        auth_request /authelia-verify;  # Call the internal authelia authentication endpoint
        error_page 403 =302 https://authelia.test.top/logout?rd=https://authelia.test.top/?rd=$scheme://$http_host$request_uri;
        error_page 401 =302 https://authelia.test.top/?rd=$scheme://$http_host$request_uri;
        return 301 https://test.top/https/example.com;
    }

    location @error {
        internal;  
        if ($authelia-failed = "403") {
            return 302 https://authelia.test.top/logout?rd=https://authelia.test.top/?rd=$scheme://$http_host$request_uri;
        }
        if ($authelia-failed = "401") {
            return 302 https://authelia.test.top/?rd=$scheme://$http_host$request_uri;
        }
        if ($status = 401) {return 401; }
        if ($status = 403) {return 403; }
    }

    location @bad-gateway  {
        return 302 "https://player.bilibili.com/player.html?isOutside=true&bvid=BV1y54y1s74a&t=58#$scheme://$host$request_uri";
    }
    
    location ~ ^/https/(?<target_domain>[^/]+)(?<target_path>/.*)?$ {
        set $target_scheme "https";
    	set $real_target_path $target_path;
        if ($target_path = "") {
            set $real_target_path "/";
        }
        set $target_url "$target_scheme://$target_domain$real_target_path$is_args$args";

        auth_request /authelia-verify;  # Call the internal authelia authentication endpoint
        ## If the verification returns a 401/403 error, redirect to the Authelia login page.
        error_page 403 401 = @error;
        
        ## After successful auth, set the user header info and proxy to the actual backend app
        #auth_request_set $user $upstream_http_remote_user;
        #auth_request_set $groups $upstream_http_remote_groups;
        #proxy_set_header Remote-User $user;
        #proxy_set_header Remote-Groups $groups;
	
    	resolver 8.8.8.8 8.8.4.4 ipv6=off valid=30s;
    	
    	proxy_pass $target_url;
    
    	proxy_intercept_errors on;  # 开启错误拦截
        #set $redirect_location '';  # 定义变量以存放重定向地址
        error_page 301 302 = @handle_redirect; 
        error_page 502 = @bad-gateway;


    	proxy_ssl_server_name on;              # 启用SNI
    	proxy_ssl_name $target_domain;
    
    	proxy_set_header Host $target_domain;
    	proxy_set_header Referer "";
    	proxy_set_header Origin "$target_scheme://$target_domain";
    	proxy_set_header X-Real-IP localhost;
    	#proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    	#proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 20G;
    	proxy_set_header Accept-Encoding "";

        proxy_buffer_size 128k;              # 增加代理缓冲区
        proxy_buffers 4 256k;                # 增加代理缓存的缓冲区大小
        proxy_busy_buffers_size 256k;

        # 4. 解决跨域：添加CORS头
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

        # 5. 处理OPTIONS预检请求
    	if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
                add_header 'Access-Control-Max-Age' 1728000; # 预检缓存 20 天
                add_header 'Content-Type' 'text/plain; charset=utf-8' always;
                add_header 'Content-Length' 0 always;
    	    return 204;
    	}

    	# Content Security Policy (CSP header)
    	proxy_hide_header Content-Security-Policy;
        add_header Content-Security-Policy "";

        # 6. 禁用代理缓存，便于调试（生产环境可启用）
    	proxy_buffering off;
    	proxy_cache off;

        # 7. 重写重定向地址（将目标站点的重定向也指向镜像）
    	#proxy_redirect ~^https?://$target_domain(.*) https://test.top/https/$target_domain$1;

        # 8. 内容替换（见下一节）
        # ...
        sub_filter "https://$target_domain" "https://test.top/https/$target_domain";
        sub_filter "http://$target_domain" "https://test.top/https/$target_domain";
    	sub_filter "https://" "https://test.top/https/";
    	sub_filter "src=\"/" "src=\"https://test.top/https/$target_domain/";
    	sub_filter "href=\"/" "href=\"https://test.top/https/$target_domain/";
    	sub_filter "action=\"/" "action=\"https://test.top/https/$target_domain/";
    	sub_filter "src=\"./" "src=\"https://test.top/https/$target_domain/";
    	sub_filter "href=\"./" "href=\"https://test.top/https/$target_domain/";
    	sub_filter "action=\"./" "action=\"https://test.top/https/$target_domain/";
    	#sub_filter '"/' '"https://test.top/https/$target_domain';
    	#sub_filter "'/" "'https://test.top/https/$target_domain";
    	#sub_filter 'url(/' 'url(https://test.top/https/$target_domain/';
    	#sub_filter 'url("/' 'url("https://test.top/https/$target_domain/';
        sub_filter_once off;  # 全局替换所有匹配项
        sub_filter_types text/html text/css text/javascript application/javascript application/x-javascript; 
    	gzip off;

    }
    location @handle_redirect {
        internal;  # 设置为内部重定向
        set $redirect_location $upstream_http_location;  # 保存重定向地址到变量
        # 可以在此处添加额外的逻辑，或直接返回重定向
    	set $modified_location "";
        if ($redirect_location ~* "^https?://authelia(.*)$") {
            return 302 $redirect_location;
        }
        if ($redirect_location ~* "^https?://(.*)$") {
            set $modified_location "https://test.top/https/$1";
        }
        # 未匹配时回退到原始值（按需调整）
        if ($modified_location = "") {
            set $modified_location $redirect_location;
        }
        return 302 $modified_location;  # 返回重定向地址
    }

}










